# pyTgMessageParserRE - это инструмент-песочница! 

## Инструкция

### Подготовка
- установить **Python 3+**
- установить библиотеку **telethon**

```commandline
pip3 install telethon
```
- получить доступ к API Telegram [здесь](https://my.telegram.org/apps)
- создать приложение и получить *api_id*, *api_hash*, вставить их в [config.py](/config.py) в соответствующие строки
```python
CONFIG_TELEGRAM = {
    'api_id': ...,
    'api_hash': '...',
    'username': 'Любое имя',
}
```

### Запуск скриптов в командной строке


#### **loader.py** - скрипт создание базы сообщений из группы в Телеграмм
```commandline
python loader.py -ch telegram_channel_name -db database_name.db --dbe --txt
```
параметры запуска скрипта:
- `-ch` - *обязательный*, наименование канала в телеграмм (прим. [covid_dobrovolec](https://t.me/covid_dobrovolec));
- `-db` - *обязательный*, путь где будет создана или расположена SQLite-база с сообщениями;
- `--dbe` - *не обязательный*, наличие данного аргумента говорит о том, что будет выполнено подключение к существующей базе;
- `--txt` - *не обязательный*, наличие данного аргумента говорит о том, что результаты будут также сохранены в текстовый файл.

Для работы скрипта используются следующие секции файла [config](/config.py):
- *CONFIG_TELEGRAM* - параметры для авторизации и получения доступа к Telegram API;
- *CONFIG_DB* - содержит путь до [схемы базы](/schema.sql) (`'base_model'`)
и запросы для добавления (`'tgm_insert_query'`), 
отчистки от пустых сообщений (`'tgm_after_insert_query'`)
и выгрузки в текстовый файл (`'tgm_export_query'`)


#### **export.py** - скрипт выгрузки данных из базы в csv-файл
```commandline
python export.py -db path_to_database_file -exp table_or_query_name --tbl
```
параметры запуска скрипта:
- `-db` - *обязательный*, путь где будет создана или расположена SQLite-база с сообщениями;
- `-exp` - *обязательный*, наименование таблицы в базе ([схема базы](/schema.sql)) или имя запроса из [config](/config.py);
- `--tbl` - *не обязательный*, наличие данного аргумента говорит о том, что выгрузка данных производится из таблицы.

В секцию **EXPORT_QUERY** файла [config](/config.py) можно добавлять произвольные SQL-запросы,
результат выполнения которых будет сохранен в csv-файл.
```python
EXPORT_QUERY = {
    'name_query_1': r"select ... from ... where ...",
    'name_query_2': r"select ... from ... where ...",
}
```

#### **re_parser.py** - скрипт разбора сообщений при помощи регулярных выражений
```commandline
python re_parser.py -db path_to_database_file -exp table_or_query_name --tbl
```
параметры запуска скрипта:
- `-db` - *обязательный*, путь где будет создана или расположена SQLite-база с сообщениями;
- `--clr` - *не обязательный*, наличие данного аргумента говорит о том, что перед обработкой таблица с результатами будет отчищена.

Данный скрипт является основным местом в котором настраивается список атрибутов (`'ATTR_SET'`)
и карта соответствия атрибутов и регулярных выражений и их дополнительных признаков (`'REGEX_MAP'`).
Также можно организовать группировку атрибутов (`'ATTR_GROUP'`), для пребразования набора атрибутов в один.

По аналогии с существующим набором атрибутов, можно добавлять новые атрибуты и их описание в карте.
